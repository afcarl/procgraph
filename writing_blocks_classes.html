

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>More complicated blocks &mdash; procgraph v0.9.0 documentation</title>
    <link rel="stylesheet" href="static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.9.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="top" title="procgraph v0.9.0 documentation" href="index.html" />
	 


   <style type="text/css">
	body { 
		font-family: Verdana, sans-serif;
		font-size: 16px;
	}

	div.col1 {
		display: block;
		float: left;
	}

	div.col2 {
		margin-left: 3em;
		display: block;
		float: left;
	}

	div.after {
		clear: left;
	}
	
</style>

<link  href="http://fonts.googleapis.com/css?family=Lobster" rel="stylesheet" type="text/css" >
<link  href="http://fonts.googleapis.com/css?family=Droid+Serif" rel="stylesheet" type="text/css" >
<link  href="static/procgraph.css" rel="stylesheet" type="text/css" >



  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>procgraph v0.9.0 documentation</span></a></h1>
        <h2 class="heading"><span>More complicated blocks</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="more-complicated-blocks">
<span id="normal-blocks"></span><h1>More complicated blocks<a class="headerlink" href="#more-complicated-blocks" title="Permalink to this headline">¶</a></h1>
<p>To create a stateful block, subclass the class <tt class="docutils literal"><span class="pre">Block</span></tt> and use the class methods
to define input, output and configuration.</p>
<div class="section" id="quick-summary-of-block-api">
<h2>Quick summary of Block API<a class="headerlink" href="#quick-summary-of-block-api" title="Permalink to this headline">¶</a></h2>
<p>Here is a summary of how to create a new block type, and how to interact with
the API:</p>
<ol class="arabic simple">
<li>Subclass <tt class="xref py py-class docutils literal"><span class="pre">Block</span></tt>.</li>
<li>Use the method <tt class="xref py py-func docutils literal"><span class="pre">Block.alias()</span></tt> to define the block type name.</li>
<li>Use the method <tt class="xref py py-func docutils literal"><span class="pre">Block.config()</span></tt> to define the block configuration (if any).</li>
<li>Use the method <tt class="xref py py-func docutils literal"><span class="pre">Block.input()</span></tt> and <tt class="xref py py-func docutils literal"><span class="pre">Block.output()</span></tt> to define input and output
signals (if any).</li>
<li><strong>do not use</strong> the <tt class="docutils literal"><span class="pre">__init__()</span></tt> method; rather, do any initialization in the <tt class="docutils literal"><span class="pre">init()</span></tt>
method, which is called once, before any input is available.</li>
<li>Put the block logic in the <tt class="docutils literal"><span class="pre">update()</span></tt> function, which is called every time a new input is available.</li>
</ol>
<p>In the <tt class="docutils literal"><span class="pre">init()</span></tt> function:</p>
<ul>
<li><p class="first">You can access configuration parameters using the syntax:</p>
<div class="highlight-python"><pre>self.config.&lt;parameter name&gt;</pre>
</div>
</li>
<li><p class="first">You can access state variables using:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">my_state</span> <span class="o">=</span> <span class="o">...</span>
</pre></div>
</div>
</li>
<li><p class="first">You cannot access input/output yet.</p>
</li>
</ul>
<p>In the <tt class="docutils literal"><span class="pre">update()</span></tt> function:</p>
<ul>
<li><p class="first">You can access configuration parameters and state variables.</p>
</li>
<li><p class="first">You can access input and output using the syntax:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">received</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="s">&#39;signal_name&#39;</span><span class="p">]</span> <span class="c"># by name</span>
<span class="n">received</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">signal_name</span>    <span class="c"># by name (syntax sugar)</span>
<span class="n">received</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>             <span class="c"># by number</span>
</pre></div>
</div>
<p>and output as well:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">processed</span> <span class="o">=</span> <span class="o">...</span>
<span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="s">&#39;processed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
<span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="example-of-a-stateless-block">
<h2>Example of a stateless block<a class="headerlink" href="#example-of-a-stateless-block" title="Permalink to this headline">¶</a></h2>
<p>The following is the minimal example of a stateless block. It defines
a gain block that could be invoked with this syntax:</p>
<div class="highlight-python"><pre>source --&gt; |gain k=2| --&gt; source_times_2</pre>
</div>
<p>Note the use of <tt class="xref py py-func docutils literal"><span class="pre">Block.alias()</span></tt> to give an alias for the block type (if not given, the class name will be used); the use of <tt class="xref py py-func docutils literal"><span class="pre">Block.config()</span></tt> to specify a configuration parameter,
and <tt class="xref py py-func docutils literal"><span class="pre">Block.input()</span></tt>, <tt class="xref py py-func docutils literal"><span class="pre">Block.output()</span></tt> to specify (and document) input and output.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">procgraph</span> <span class="kn">import</span> <span class="n">Block</span>

<span class="k">class</span> <span class="nc">Gain</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; A simple example of a gain block. &#39;&#39;&#39;</span>

    <span class="n">Block</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;gain&#39;</span><span class="p">)</span>

    <span class="n">Block</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s">&#39;k&#39;</span><span class="p">,</span> <span class="s">&#39;Multiplicative gain&#39;</span><span class="p">)</span>

    <span class="n">Block</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="s">&#39;Input value&#39;</span><span class="p">)</span>
    <span class="n">Block</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s">&#39;out&#39;</span><span class="p">,</span> <span class="s">&#39;Output multiplied by k.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">k</span>
        <span class="c"># equivalent to:</span>
        <span class="c"># self.output[&#39;out&#39;] = self.input[&#39;in&#39;] * self.config.k</span>
</pre></div>
</div>
<p>The &#8220;meat&#8221; of the block goes in the <tt class="docutils literal"><span class="pre">update()</span></tt> function. It is called whenever
one of the inputs change. In the <tt class="docutils literal"><span class="pre">update()</span></tt> function, you compute the
output from the input. To access the input, there are several</p>
</div>
<div class="section" id="example-of-a-stateful-block">
<h2>Example of a stateful block<a class="headerlink" href="#example-of-a-stateful-block" title="Permalink to this headline">¶</a></h2>
<p>The following is a minimal example of a stateful block. It has one input and one output.
The output is the sample average of the input. There are two state variables: the number
of samples processed and the current sample average.</p>
<p>Note how the block uses the <tt class="docutils literal"><span class="pre">init()</span></tt> function to initialize its structures,
and the <tt class="docutils literal"><span class="pre">self.state</span></tt> structure to hold them.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Expectation</span><span class="p">(</span><span class="n">Block</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Computes the sample expectation of a signal. &#39;&#39;&#39;</span>
    <span class="n">Block</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s">&#39;expectation&#39;</span><span class="p">)</span>

    <span class="n">Block</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="s">&#39;Any numpy array.&#39;</span><span class="p">)</span>
    <span class="n">Block</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="s">&#39;Ex&#39;</span><span class="p">,</span> <span class="s">&#39;Expectation of input.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_samples</span>

        <span class="k">if</span> <span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">Ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">Ex</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">Ex</span> <span class="o">*</span> <span class="n">N</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">Ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">Ex</span>
</pre></div>
</div>
<p>(See <em class="xref std std-ref">execution_model</em> for advanced topics dealing with timestamp)</p>
</div>
<div class="section" id="the-init-method">
<h2>The init() method<a class="headerlink" href="#the-init-method" title="Permalink to this headline">¶</a></h2>
<p>Do not use your class&#8217;s constructor to initialize the block. There are
all sorts of issues with custom constructors that make writing things
such as module serialization hard.</p>
<p>Instead, <a href="#id1"><span class="problematic" id="id2">|procgraph|</span></a> provides the facilities you need for configuration,
initialization, etc.</p>
<dl class="docutils">
<dt>The init() method is supposed to set up</dt>
<dd>method: basic usage.</dd>
</dl>
<p>The return value of init() is ignored, except in one special case described in the
next section.</p>
<p>Advanced init() usage &#8211; partial initialization</p>
<p>Note that there some special cases for which initialization cannot be
completed before until the block is in the model and signals are connected.
One typical example is when we want to write a block that can operate
on multiple signal, of which we do not know the number. Consider as an example
the case in which we want to write a block performing a &#8220;min&#8221; operation.:</p>
<div class="highlight-python"><pre># three values
|constant value=1| -&gt; x
|constant value=2| -&gt; y
|constant value=3| -&gt; z

# take the min
x,y,z -&gt; |min| -&gt; minimum</pre>
</div>
<p>When the block min is initialized, it is outside the block</p>
</div>
<div class="section" id="the-update-method">
<h2>The update() method<a class="headerlink" href="#the-update-method" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">If the computation is not finished, return Block.UPDATE_NOT_FINISHED.
This will tell <a href="#id3"><span class="problematic" id="id4">|procgraph|</span></a> to consider the computation still pending,
and update() will be called again in the future with the same input signals.</p>
<p>All other return values are just ignored by <a href="#id5"><span class="problematic" id="id6">|procgraph|</span></a>.</p>
</li>
</ul>
</div>
<div class="section" id="the-finish-method">
<h2>The finish() method<a class="headerlink" href="#the-finish-method" title="Permalink to this headline">¶</a></h2>
<p><a href="#id7"><span class="problematic" id="id8">|towrite|</span></a></p>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="index.html">Contents</a>
        </p>

      </div>

	
    <div class="footer">
        &copy; Copyright 2010, Andrea Censi.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.5.
    </div>
	
	<script type="text/javascript">

	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-155626-6']);
	  _gaq.push(['_trackPageview']);

	  (function() {
	    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>


  </body>
</html>